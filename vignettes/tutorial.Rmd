---
title: "How to Simulate Water Balance with R-Abimo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to Simulate Water Balance with R-Abimo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Background

This package provides an R-implementation and extension of the simple water 
balance model Berlin ABIMO 3.2, which was originally developed by the Federal
Institute of Hydrology ([Bundesanstalt für Gewässerkunde](https://www.bafg.de)) 
for rural areas and later adapted for urban areas, namely for Berlin, Germany.
In May 2022, the source code of the model was published on the developer
platform GitHub ([https://github.com/umweltatlas/abimo](https://github.com/umweltatlas/abimo)). 

During the research project [AMAREX](https://amarex-projekt.de/de) (an acronym 
for the German translation of "adaptation of stormwater management to extreme
events"), funded by the former German Federal Ministry of Education and Research
([Bundesministerium für Bildung und Forschung -- BMBF](https://www.bmbf.de/DE/Home/home_node.html)), we, the package authors from [Kompetenzzentrum Wasser Berlin gGmbH (KWB)](https://kompetenz-wasser.de/de) 
started to work on the original program code, written in the programming language C++ ([https://github.com/KWB-R/abimo](https://github.com/KWB-R/abimo/)). 
We then decided to transfer the model to the 
[programming language R](https://www.r-project.org/), to rename it to
R-Abimo (see e.g. [here](https://amarex-projekt.de/en/news/abimo-r-abimo)) 
and to publish it in the form of this R package [kwb.rabimo](https://github.com/KWB-R/kwb.rabimo). 
Compared to the original model, R-Abimo is more generic (i.e. can be more easily
adapted to other cities than Berlin) and it contains some additional features:

- simulation of stormwater management measures (green roofs, swales),
- "conversion" of urban areas to "natural" areas,
- calculation of delta-W, an indicator for the deviation between the urban (status quo) state and an assumed "natural" state.

## Prerequisites

To use the package, you need to have R installed in a version >= 4.3.1. 
You can download the current version of R from [here](https://cran.r-project.org/bin/windows/base/).
Not necessary, but useful, is the usage of an Integrated Development Environment (IDE), such as RStudio Desktop that can be downloaded from
[here](https://posit.co/download/rstudio-desktop/).

## Installation

In order to install kwb.rabimo directly from our GitHub account [KWB-R](https://github.com/kwb-r/), we recommend to install the R package 
remotes first: 

```{r install_remotes, eval = FALSE}
# Install package "remotes" from CRAN
install.packages("remotes")
```

You can then install kwb.rabimo either in the latest "official" version:

```{r install_rabimo_release, eval = FALSE}
# Install package "kwb.rabimo" (latest "release") from GitHub
remotes::install_github("KWB-R/kwb.rabimo")
```

or in the latest "development" version:

```{r install_rabimo_dev, eval = FALSE}
# Install package "kwb.rabimo" (development version) from GitHub
remotes::install_github("KWB-R/kwb.rabimo@dev", build_vignettes = TRUE)
```

By setting `build_vignettes = TRUE` you make sure that this tutorial vignette
is installed together with the package. Please note that this tutorial is
currently only available in the "development" version. 

## Basic Usage

### Provide input data and configuration

Compared to the original C++ version of Abimo we have modified the structures
of input data, output data and configuration.
For Berlin, Germany, we provide data in the new structures in the 
package:

```{r load_berlin_data}
# Load Berlin data in the original Abimo format
abimo_inputs <- kwb.rabimo::rabimo_inputs_2025
```

The object `abimo_inputs` is a list with two elements:

- `abimo_inputs$data` is a data frame containing the actual input data. Each row 
represents a block area and each column represents a block area's property.
- `abimo_inputs$config` is a list that configures runoff factors (for 
runoff calculation) and Bagrov values (for evapotranspiration calculation) for 
different surface types and the swale evaporation factor that determines which
fraction of the water going into a swale becomes evaporation (the rest becomes
infiltration).

You may inspect the first rows (and only the most relevant columns) of the input 
data with

```{r view_input_data}
head(as.data.frame(abimo_inputs$data)[, 1:24])
```

and you may print the whole configuration object with

```{r view_input_config}
abimo_inputs$config
```

Please refer to the help page of `rabimo_inputs_2025` for further information. 
To open the help page, run

```{r help_input, eval = FALSE}
?kwb.rabimo::rabimo_inputs_2025
```

**Note:** We provide also an object `rabimo_inputs_2020`, that refers to an older 
version of the Berlin data set. It can be used in almost the same way as
`rabimo_inputs_2025`. However, this old version does not contain geographical 
information and we do not cover it within this tutorial.

Since the we provide the Berlin dataset together with geographical information 
we can plot the spatial distribution of a variable (e.g. the annual 
precipitation) in the form of a map:

```{r, fig.width=5}
# Load the sf package (simple features) to allow for geographical plotting
library(sf)

# Provide a subset of the data representing a zoom into the centre of Berlin
berlin_zoom <- kwb.rabimo::crop_box(
  abimo_inputs$data, 
  xoffset = 0.35, 
  yoffset = 0.5, 
  xscale = 0.07, 
  yscale = 0.07
)

# Plot annual precipitation
plot(berlin_zoom[, "prec_yr"], main = "Annual precipitation in mm")
```

### Run R-Abimo for the status quo

To run R-Abimo, call the main function `run_rabimo()` by passing both, the input 
data and the configuration object, to the function:


```{r run_rabimo}
# Run R-Abimo
water_balance_urban <- kwb.rabimo::run_rabimo(
  data = berlin_zoom, 
  config = abimo_inputs$config
)

# Have a look at the first lines of the result data frame
head(sf::st_drop_geometry(water_balance_urban))
```
The result data frame contains two columns that are copied from the input data:

- `code` - unique identifier of each block area,
- `area` - the total block area in square metres in column `area

as well as three columns containing the model outputs, namely the water balance
components:

- `runoff` - surface runoff in mm,
- `infiltration` - infiltration in mm, and
- `evapor` - evaporation in mm.

If the model inputs contained geographical information (as in our case) that 
information is restored in the output so that the model results can be plotted
in terms of maps:

```{r plot_rabimo_results}
# Plot model output "runoff"
plot(water_balance_urban[, "runoff"], main = "Annual runoff in mm")

# Plot model output "infiltration"
plot(water_balance_urban[, "infiltr"], main = "Annual infiltratio in mm")

# Plot model output "evaporation"
plot(water_balance_urban[, "evapor"], main = "Annual evaporation in mm")
```

### Generate your own block areas

The package provides a function to generate a row in the format that R-Abimo
requires. You need to pass at least the unique identifier(s) (`code`) for the 
block area(s). If you leave all the other arguments blank, you get (a) default 
block area(s). 
However, you can override the default values by passing arguments that are named
according to the names of the input columns:

```{r generate_block_areas}
# Generate artificial block areas, using default values and differing only in 
# the fractions of the areas that are refer to roofs
codes <- paste0("area-", 1:5)
art_blocks <- kwb.rabimo::generate_rabimo_area(
  code = codes, 
  roof = seq(0, 1, length.out = length(codes))
)

# Have a look at the data
art_blocks

# Run R-Abimo on the block areas
art_water_balance <- kwb.rabimo::run_rabimo(art_blocks, config = abimo_inputs$config)

# How does the roof area influence the runoff?
plot(art_blocks$roof, art_water_balance$runoff)
```

## Comparison of urban state with natural state

In the research project [AMAREX](https://amarex-projekt.de/de) we propose to 
use the deviation of the water balances that are simulated for both, the current 
(urban) state and for an assumed "natural" state as an indicator for the 
vulnerability of an urban area to climate change effects (such as heat, 
flooding, negative impacts on the surface water quality). As a measure of
deviation we introduce $\Delta W$ that is calculated as follows:

$$\Delta W = \frac{1}{2}(|e_{nat}-e_{urb}|+|i_{nat}-i_{urb}|+|r_{nat}-r_{urb}|)$$
with 

- $e_{nat}$ and $e_{urb}$ = evaporation for the natural and urban state, respectively,
- $i_{nat}$ and $i_{urb}$ = infiltration for the natural and urban state, respectively,
- $r_{nat}$ and $r_{urb}$ = runoff for the natural and urban state, respectively.

The higher the value of $\Delta W$ the more different are the water balance 
components, i.e. the less similar the urban area is to a natural area. 
The lower the value of  $\Delta W$ the less different are the water balance 
components, i.e. the more similar the urban area is to a natural area.

The hypothesis is that a lower value of $\Delta W$ indicates a better 
preparedness to climate change effects (e.g. because increased evaporation as 
it occurs in a natural state scenario leads to a reduction of heat).

### Run R-Abimo for a natural state scenario

In the package we provide a function `data_to_natural()` that converts a set of 
urban block areas to corresponding "natural" block areas. The function converts 
all roof areas and unbuilt paved areas to pervious areas and assumes an overall 
vegetation as it can be found in a park (a mixture of meadows, bushes and trees).

```{r calculate_natural_state}
# Convert urban state to "natural" state
berlin_zoom_natural <- kwb.rabimo::data_to_natural(berlin_zoom)

# Calculate the water balance for the "natural" state
water_balance_natural <- kwb.rabimo::run_rabimo(
  data = berlin_zoom_natural, 
  config = abimo_inputs$config
)
```

### Calculate "Delta-W"

For the first ten blocks, calculate the deviation from the natural state:

```r
kwb.rabimo::calculate_delta_w(
  urban = rabimo_result[1:10, ],
  natural = rabimo_result_natural
)
```

TODO:
- calculate_delta_w
- RWBM
  - sehr kurze Intro zu den implementierten RWBM (inkl. dass man den pvd Anteil ändern kann?)
  - wie man gezielt einen Wert in einer bestimmten Spalte (z.B. green_roof) oder in alle Spalten ändert
  - Plot von vorher vs. nachher
